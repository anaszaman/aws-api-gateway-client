"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _axios = _interopRequireDefault(require("axios"));

var _axiosRetry = _interopRequireDefault(require("axios-retry"));

var _sha = _interopRequireDefault(require("crypto-js/sha256"));

var _encHex = _interopRequireDefault(require("crypto-js/enc-hex"));

var _hmacSha = _interopRequireDefault(require("crypto-js/hmac-sha256"));

var _url = _interopRequireDefault(require("url"));

var _utils = _interopRequireDefault(require("./utils"));

/*
 * Copyright 2010-2016 Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License").
 * You may not use this file except in compliance with the License.
 * A copy of the License is located at
 *
 *  http://aws.amazon.com/apache2.0
 *
 * or in the "license" file accompanying this file. This file is distributed
 * on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either
 * express or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */
var sigV4ClientFactory = {};

sigV4ClientFactory.newClient = function (config) {
  var AWS_SHA_256 = 'AWS4-HMAC-SHA256';
  var AWS4_REQUEST = 'aws4_request';
  var AWS4 = 'AWS4';
  var X_AMZ_DATE = 'x-amz-date';
  var X_AMZ_SECURITY_TOKEN = 'x-amz-security-token';
  var HOST = 'host';
  var AUTHORIZATION = 'Authorization';

  function hash(value) {
    return (0, _sha["default"])(value); // eslint-disable-line
  }

  function hexEncode(value) {
    return value.toString(_encHex["default"]);
  }

  function hmac(secret, value) {
    return (0, _hmacSha["default"])(value, secret, {
      asBytes: true
    }); // eslint-disable-line
  }

  function buildCanonicalRequest(method, path, queryParams, headers, payload) {
    return method + '\n' + buildCanonicalUri(path) + '\n' + buildCanonicalQueryString(queryParams) + '\n' + buildCanonicalHeaders(headers) + '\n' + buildCanonicalSignedHeaders(headers) + '\n' + hexEncode(hash(payload));
  }

  function hashCanonicalRequest(request) {
    return hexEncode(hash(request));
  }

  function buildCanonicalUri(uri) {
    return encodeURI(uri);
  }

  function buildCanonicalQueryString(queryParams) {
    if (Object.keys(queryParams).length < 1) {
      return '';
    }

    var sortedQueryParams = [];

    for (var property in queryParams) {
      if (Object.prototype.hasOwnProperty.call(queryParams, "property")) {
        sortedQueryParams.push(property);
      }
    }

    sortedQueryParams.sort();
    var canonicalQueryString = '';

    for (var i = 0; i < sortedQueryParams.length; i++) {
      canonicalQueryString += sortedQueryParams[i] + '=' + fixedEncodeURIComponent(queryParams[sortedQueryParams[i]]) + '&';
    }

    return canonicalQueryString.substr(0, canonicalQueryString.length - 1);
  }

  function fixedEncodeURIComponent(str) {
    return encodeURIComponent(str).replace(/[!'()*]/g, function (c) {
      return '%' + c.charCodeAt(0).toString(16);
    });
  }

  function buildCanonicalHeaders(headers) {
    var canonicalHeaders = '';
    var sortedKeys = [];

    for (var property in headers) {
      if (Object.prototype.hasOwnProperty.call(headers, "property")) {
        sortedKeys.push(property);
      }
    }

    sortedKeys.sort();

    for (var i = 0; i < sortedKeys.length; i++) {
      canonicalHeaders += sortedKeys[i].toLowerCase() + ':' + headers[sortedKeys[i]] + '\n';
    }

    return canonicalHeaders;
  }

  function buildCanonicalSignedHeaders(headers) {
    var sortedKeys = [];

    for (var property in headers) {
      if (Object.prototype.hasOwnProperty.call(headers, "property")) {
        sortedKeys.push(property.toLowerCase());
      }
    }

    sortedKeys.sort();
    return sortedKeys.join(';');
  }

  function buildStringToSign(datetime, credentialScope, hashedCanonicalRequest) {
    return AWS_SHA_256 + '\n' + datetime + '\n' + credentialScope + '\n' + hashedCanonicalRequest;
  }

  function buildCredentialScope(datetime, region, service) {
    return datetime.substr(0, 8) + '/' + region + '/' + service + '/' + AWS4_REQUEST;
  }

  function calculateSigningKey(secretKey, datetime, region, service) {
    return hmac(hmac(hmac(hmac(AWS4 + secretKey, datetime.substr(0, 8)), region), service), AWS4_REQUEST);
  }

  function calculateSignature(key, stringToSign) {
    return hexEncode(hmac(key, stringToSign));
  }

  function buildAuthorizationHeader(accessKey, credentialScope, headers, signature) {
    return AWS_SHA_256 + ' Credential=' + accessKey + '/' + credentialScope + ', SignedHeaders=' + buildCanonicalSignedHeaders(headers) + ', Signature=' + signature;
  }

  var awsSigV4Client = {};

  if (config.accessKey === undefined || config.secretKey === undefined) {
    return awsSigV4Client;
  }

  awsSigV4Client.accessKey = _utils["default"].assertDefined(config.accessKey, 'accessKey');
  awsSigV4Client.secretKey = _utils["default"].assertDefined(config.secretKey, 'secretKey');
  awsSigV4Client.sessionToken = config.sessionToken;
  awsSigV4Client.serviceName = _utils["default"].assertDefined(config.serviceName, 'serviceName');
  awsSigV4Client.region = _utils["default"].assertDefined(config.region, 'region');
  awsSigV4Client.endpoint = _utils["default"].assertDefined(config.endpoint, 'endpoint');
  awsSigV4Client.retries = config.retries;
  awsSigV4Client.retryCondition = config.retryCondition;
  awsSigV4Client.retryDelay = config.retryDelay;
  awsSigV4Client.host = config.host;

  awsSigV4Client.makeRequest = function (request) {
    var verb = _utils["default"].assertDefined(request.verb, 'verb');

    var path = _utils["default"].assertDefined(request.path, 'path');

    var queryParams = _utils["default"].copy(request.queryParams);

    var timeout = _utils["default"].copy(request.timeout);

    if (queryParams === undefined) {
      queryParams = {};
    }

    if (timeout === undefined) {
      timeout = 0;
    }

    var headers = _utils["default"].copy(request.headers);

    if (headers === undefined) {
      headers = {};
    } // If the user has not specified an override for Content type the use default


    if (headers['Content-Type'] === undefined) {
      headers['Content-Type'] = config.defaultContentType;
    } // If the user has not specified an override for Accept type the use default


    if (headers['Accept'] === undefined) {
      headers['Accept'] = config.defaultAcceptType;
    }

    var body = _utils["default"].copy(request.body); // stringify request body if content type is JSON


    if (body && headers['Content-Type'] && headers['Content-Type'] === 'application/json') {
      body = JSON.stringify(body);
    } // If there is no body remove the content-type header so it is not included in SigV4 calculation


    if (body === '' || body === undefined || body === null) {
      delete headers['Content-Type'];
    }

    var datetime = new Date(new Date().getTime() + config.systemClockOffset).toISOString().replace(/\.\d{3}Z$/, 'Z').replace(/[:-]|\.\d{3}/g, '');
    headers[X_AMZ_DATE] = datetime;

    if (awsSigV4Client.host) {
      headers[HOST] = awsSigV4Client.host;
    } else {
      var parser = _url["default"].parse(awsSigV4Client.endpoint);

      headers[HOST] = parser.host;
    }

    var canonicalRequest = buildCanonicalRequest(verb, path, queryParams, headers, body);
    var hashedCanonicalRequest = hashCanonicalRequest(canonicalRequest);
    var credentialScope = buildCredentialScope(datetime, awsSigV4Client.region, awsSigV4Client.serviceName);
    var stringToSign = buildStringToSign(datetime, credentialScope, hashedCanonicalRequest);
    var signingKey = calculateSigningKey(awsSigV4Client.secretKey, datetime, awsSigV4Client.region, awsSigV4Client.serviceName);
    var signature = calculateSignature(signingKey, stringToSign);
    headers[AUTHORIZATION] = buildAuthorizationHeader(awsSigV4Client.accessKey, credentialScope, headers, signature);

    if (awsSigV4Client.sessionToken !== undefined && awsSigV4Client.sessionToken !== '') {
      headers[X_AMZ_SECURITY_TOKEN] = awsSigV4Client.sessionToken;
    }

    delete headers[HOST];
    var url = config.endpoint + path;
    var queryString = buildCanonicalQueryString(queryParams);

    if (queryString !== '') {
      url += '?' + queryString;
    } // Need to re-attach Content-Type if it is not specified at this point


    if (headers['Content-Type'] === undefined) {
      headers['Content-Type'] = config.defaultContentType;
    }

    var signedRequest = {
      headers: headers,
      timeout: timeout,
      data: body
    };

    if (config.retries !== undefined) {
      signedRequest.baseURL = url;

      var client = _axios["default"].create(signedRequest); // Allow user configurable delay, or built-in exponential delay


      var retryDelay = function retryDelay() {
        return 0;
      };

      if (config.retryDelay === 'exponential') {
        retryDelay = _axiosRetry["default"].exponentialDelay;
      } else if (typeof config.retryDelay === 'number') {
        retryDelay = function retryDelay() {
          return parseInt(config.retryDelay);
        };
      } else if (typeof config.retryDelay === 'function') {
        retryDelay = config.retryDelay;
      }

      (0, _axiosRetry["default"])(client, {
        retries: config.retries,
        retryCondition: config.retryCondition,
        retryDelay: retryDelay
      });
      return client.request({
        method: verb
      });
    }

    signedRequest.method = verb;
    signedRequest.url = url;
    return (0, _axios["default"])(signedRequest);
  };

  return awsSigV4Client;
};

var _default = sigV4ClientFactory;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9saWIvYXBpR2F0ZXdheUNvcmUvc2lnVjRDbGllbnQuanMiXSwibmFtZXMiOlsic2lnVjRDbGllbnRGYWN0b3J5IiwibmV3Q2xpZW50IiwiY29uZmlnIiwiQVdTX1NIQV8yNTYiLCJBV1M0X1JFUVVFU1QiLCJBV1M0IiwiWF9BTVpfREFURSIsIlhfQU1aX1NFQ1VSSVRZX1RPS0VOIiwiSE9TVCIsIkFVVEhPUklaQVRJT04iLCJoYXNoIiwidmFsdWUiLCJoZXhFbmNvZGUiLCJ0b1N0cmluZyIsImVuY0hleCIsImhtYWMiLCJzZWNyZXQiLCJhc0J5dGVzIiwiYnVpbGRDYW5vbmljYWxSZXF1ZXN0IiwibWV0aG9kIiwicGF0aCIsInF1ZXJ5UGFyYW1zIiwiaGVhZGVycyIsInBheWxvYWQiLCJidWlsZENhbm9uaWNhbFVyaSIsImJ1aWxkQ2Fub25pY2FsUXVlcnlTdHJpbmciLCJidWlsZENhbm9uaWNhbEhlYWRlcnMiLCJidWlsZENhbm9uaWNhbFNpZ25lZEhlYWRlcnMiLCJoYXNoQ2Fub25pY2FsUmVxdWVzdCIsInJlcXVlc3QiLCJ1cmkiLCJlbmNvZGVVUkkiLCJPYmplY3QiLCJrZXlzIiwibGVuZ3RoIiwic29ydGVkUXVlcnlQYXJhbXMiLCJwcm9wZXJ0eSIsInByb3RvdHlwZSIsImhhc093blByb3BlcnR5IiwiY2FsbCIsInB1c2giLCJzb3J0IiwiY2Fub25pY2FsUXVlcnlTdHJpbmciLCJpIiwiZml4ZWRFbmNvZGVVUklDb21wb25lbnQiLCJzdWJzdHIiLCJzdHIiLCJlbmNvZGVVUklDb21wb25lbnQiLCJyZXBsYWNlIiwiYyIsImNoYXJDb2RlQXQiLCJjYW5vbmljYWxIZWFkZXJzIiwic29ydGVkS2V5cyIsInRvTG93ZXJDYXNlIiwiam9pbiIsImJ1aWxkU3RyaW5nVG9TaWduIiwiZGF0ZXRpbWUiLCJjcmVkZW50aWFsU2NvcGUiLCJoYXNoZWRDYW5vbmljYWxSZXF1ZXN0IiwiYnVpbGRDcmVkZW50aWFsU2NvcGUiLCJyZWdpb24iLCJzZXJ2aWNlIiwiY2FsY3VsYXRlU2lnbmluZ0tleSIsInNlY3JldEtleSIsImNhbGN1bGF0ZVNpZ25hdHVyZSIsImtleSIsInN0cmluZ1RvU2lnbiIsImJ1aWxkQXV0aG9yaXphdGlvbkhlYWRlciIsImFjY2Vzc0tleSIsInNpZ25hdHVyZSIsImF3c1NpZ1Y0Q2xpZW50IiwidW5kZWZpbmVkIiwidXRpbHMiLCJhc3NlcnREZWZpbmVkIiwic2Vzc2lvblRva2VuIiwic2VydmljZU5hbWUiLCJlbmRwb2ludCIsInJldHJpZXMiLCJyZXRyeUNvbmRpdGlvbiIsInJldHJ5RGVsYXkiLCJob3N0IiwibWFrZVJlcXVlc3QiLCJ2ZXJiIiwiY29weSIsInRpbWVvdXQiLCJkZWZhdWx0Q29udGVudFR5cGUiLCJkZWZhdWx0QWNjZXB0VHlwZSIsImJvZHkiLCJKU09OIiwic3RyaW5naWZ5IiwiRGF0ZSIsImdldFRpbWUiLCJzeXN0ZW1DbG9ja09mZnNldCIsInRvSVNPU3RyaW5nIiwicGFyc2VyIiwidXJsUGFyc2VyIiwicGFyc2UiLCJjYW5vbmljYWxSZXF1ZXN0Iiwic2lnbmluZ0tleSIsInVybCIsInF1ZXJ5U3RyaW5nIiwic2lnbmVkUmVxdWVzdCIsImRhdGEiLCJiYXNlVVJMIiwiY2xpZW50IiwiYXhpb3MiLCJjcmVhdGUiLCJheGlvc1JldHJ5IiwiZXhwb25lbnRpYWxEZWxheSIsInBhcnNlSW50Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFlQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFyQkE7Ozs7Ozs7Ozs7Ozs7O0FBdUJBLElBQU1BLGtCQUFrQixHQUFHLEVBQTNCOztBQUNBQSxrQkFBa0IsQ0FBQ0MsU0FBbkIsR0FBK0IsVUFBU0MsTUFBVCxFQUFpQjtBQUM5QyxNQUFJQyxXQUFXLEdBQUcsa0JBQWxCO0FBQ0EsTUFBSUMsWUFBWSxHQUFHLGNBQW5CO0FBQ0EsTUFBSUMsSUFBSSxHQUFHLE1BQVg7QUFDQSxNQUFJQyxVQUFVLEdBQUcsWUFBakI7QUFDQSxNQUFJQyxv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RUFBRTNFLE1BQU0sQ0FBQzJFLE9BREM7QUFFakJDLFFBQUFBLGNBQWMsRUFBRTVFLE1BQU0sQ0FBQzRFLGNBRk47QUFHakJDLFFBQUFBLFVBQVUsRUFBVkE7QUFIaUIsT0FBbkI7QUFLQSxhQUFPeUIsTUFBTSxDQUFDM0UsT0FBUCxDQUFlO0FBQUNWLFFBQUFBLE1BQU0sRUFBRStEO0FBQVQsT0FBZixDQUFQO0FBQ0Q7O0FBQ0RtQixJQUFBQSxhQUFhLENBQUNsRixNQUFkLEdBQXVCK0QsSUFBdkI7QUFDQW1CLElBQUFBLGFBQWEsQ0FBQ0YsR0FBZCxHQUFvQkEsR0FBcEI7QUFDQSxXQUFPLHVCQUFNRSxhQUFOLENBQVA7QUFDRCxHQXZIRDs7QUF5SEEsU0FBTy9CLGNBQVA7QUFDRCxDQWpRRDs7ZUFtUWV0RSxrQiIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgMjAxMC0yMDE2IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKS5cbiAqIFlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIEEgY29weSBvZiB0aGUgTGljZW5zZSBpcyBsb2NhdGVkIGF0XG4gKlxuICogIGh0dHA6Ly9hd3MuYW1hem9uLmNvbS9hcGFjaGUyLjBcbiAqXG4gKiBvciBpbiB0aGUgXCJsaWNlbnNlXCIgZmlsZSBhY2NvbXBhbnlpbmcgdGhpcyBmaWxlLiBUaGlzIGZpbGUgaXMgZGlzdHJpYnV0ZWRcbiAqIG9uIGFuIFwiQVMgSVNcIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlclxuICogZXhwcmVzcyBvciBpbXBsaWVkLiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmdcbiAqIHBlcm1pc3Npb25zIGFuZCBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgYXhpb3MgZnJvbSAnYXhpb3MnO1xuaW1wb3J0IGF4aW9zUmV0cnkgZnJvbSAnYXhpb3MtcmV0cnknO1xuaW1wb3J0IFNIQTI1NiBmcm9tICdjcnlwdG8tanMvc2hhMjU2JztcbmltcG9ydCBlbmNIZXggZnJvbSAnY3J5cHRvLWpzL2VuYy1oZXgnO1xuaW1wb3J0IEhtYWNTSEEyNTYgZnJvbSAnY3J5cHRvLWpzL2htYWMtc2hhMjU2JztcbmltcG9ydCB1cmxQYXJzZXIgZnJvbSAndXJsJztcbmltcG9ydCB1dGlscyBmcm9tICcuL3V0aWxzJztcblxuY29uc3Qgc2lnVjRDbGllbnRGYWN0b3J5ID0ge307XG5zaWdWNENsaWVudEZhY3RvcnkubmV3Q2xpZW50ID0gZnVuY3Rpb24oY29uZmlnKSB7XG4gIGxldCBBV1NfU0hBXzI1NiA9ICdBV1M0LUhNQUMtU0hBMjU2JztcbiAgbGV0IEFXUzRfUkVRVUVTVCA9ICdhd3M0X3JlcXVlc3QnO1xuICBsZXQgQVdTNCA9ICdBV1M0JztcbiAgbGV0IFhfQU1aX0RBVEUgPSAneC1hbXotZGF0ZSc7XG4gIGxldCBYX0FNWl9TRUNVUklUWV9UT0tFTiA9ICd4LWFtei1zZWN1cml0eS10b2tlbic7XG4gIGxldCBIT1NUID0gJ2hvc3QnO1xuICBsZXQgQVVUSE9SSVpBVElPTiA9ICdBdXRob3JpemF0aW9uJztcblxuICBmdW5jdGlvbiBoYXNoKHZhbHVlKSB7XG4gICAgcmV0dXJuIFNIQTI1Nih2YWx1ZSk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmVcbiAgfVxuXG4gIGZ1bmN0aW9uIGhleEVuY29kZSh2YWx1ZSkge1xuICAgIHJldHVybiB2YWx1ZS50b1N0cmluZyhlbmNIZXgpO1xuICB9XG5cbiAgZnVuY3Rpb24gaG1hYyhzZWNyZXQsIHZhbHVlKSB7XG4gICAgcmV0dXJuIEhtYWNTSEEyNTYodmFsdWUsIHNlY3JldCwge2FzQnl0ZXM6IHRydWV9KTsgLy8gZXNsaW50LWRpc2FibGUtbGluZVxuICB9XG5cbiAgZnVuY3Rpb24gYnVpbGRDYW5vbmljYWxSZXF1ZXN0KG1ldGhvZCwgcGF0aCwgcXVlcnlQYXJhbXMsIGhlYWRlcnMsIHBheWxvYWQpIHtcbiAgICByZXR1cm4gbWV0aG9kICsgJ1xcbicgK1xuICAgICAgYnVpbGRDYW5vbmljYWxVcmkocGF0aCkgKyAnXFxuJyArXG4gICAgICBidWlsZENhbm9uaWNhbFF1ZXJ5U3RyaW5nKHF1ZXJ5UGFyYW1zKSArICdcXG4nICtcbiAgICAgIGJ1aWxkQ2Fub25pY2FsSGVhZGVycyhoZWFkZXJzKSArICdcXG4nICtcbiAgICAgIGJ1aWxkQ2Fub25pY2FsU2lnbmVkSGVhZGVycyhoZWFkZXJzKSArICdcXG4nICtcbiAgICAgIGhleEVuY29kZShoYXNoKHBheWxvYWQpKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGhhc2hDYW5vbmljYWxSZXF1ZXN0KHJlcXVlc3QpIHtcbiAgICByZXR1cm4gaGV4RW5jb2RlKGhhc2gocmVxdWVzdCkpO1xuICB9XG5cbiAgZnVuY3Rpb24gYnVpbGRDYW5vbmljYWxVcmkodXJpKSB7XG4gICAgcmV0dXJuIGVuY29kZVVSSSh1cmkpO1xuICB9XG5cbiAgZnVuY3Rpb24gYnVpbGRDYW5vbmljYWxRdWVyeVN0cmluZyhxdWVyeVBhcmFtcykge1xuICAgIGlmIChPYmplY3Qua2V5cyhxdWVyeVBhcmFtcykubGVuZ3RoIDwgMSkge1xuICAgICAgcmV0dXJuICcnO1xuICAgIH1cblxuICAgIGxldCBzb3J0ZWRRdWVyeVBhcmFtcyA9IFtdO1xuICAgIGZvciAobGV0IHByb3BlcnR5IGluIHF1ZXJ5UGFyYW1zKSB7XG4gICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHF1ZXJ5UGFyYW1zLCBcInByb3BlcnR5XCIpKSB7XG4gICAgICAgIHNvcnRlZFF1ZXJ5UGFyYW1zLnB1c2gocHJvcGVydHkpO1xuICAgICAgfVxuICAgIH1cbiAgICBzb3J0ZWRRdWVyeVBhcmFtcy5zb3J0KCk7XG5cbiAgICBsZXQgY2Fub25pY2FsUXVlcnlTdHJpbmcgPSAnJztcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNvcnRlZFF1ZXJ5UGFyYW1zLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjYW5vbmljYWxRdWVyeVN0cmluZyArPSBzb3J0ZWRRdWVyeVBhcmFtc1tpXVxuICAgICAgICArICc9JyArIGZpeGVkRW5jb2RlVVJJQ29tcG9uZW50KHF1ZXJ5UGFyYW1zW3NvcnRlZFF1ZXJ5UGFyYW1zW2ldXSkgKyAnJic7XG4gICAgfVxuICAgIHJldHVybiBjYW5vbmljYWxRdWVyeVN0cmluZy5zdWJzdHIoMCwgY2Fub25pY2FsUXVlcnlTdHJpbmcubGVuZ3RoIC0gMSk7XG4gIH1cblxuICBmdW5jdGlvbiBmaXhlZEVuY29kZVVSSUNvbXBvbmVudChzdHIpIHtcbiAgICByZXR1cm4gZW5jb2RlVVJJQ29tcG9uZW50KHN0cikucmVwbGFjZSgvWyEnKCkqXS9nLCBmdW5jdGlvbihjKSB7XG4gICAgICByZXR1cm4gJyUnICsgYy5jaGFyQ29kZUF0KDApLnRvU3RyaW5nKDE2KTtcbiAgICB9KTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGJ1aWxkQ2Fub25pY2FsSGVhZGVycyhoZWFkZXJzKSB7XG4gICAgbGV0IGNhbm9uaWNhbEhlYWRlcnMgPSAnJztcbiAgICBsZXQgc29ydGVkS2V5cyA9IFtdO1xuICAgIGZvciAobGV0IHByb3BlcnR5IGluIGhlYWRlcnMpIHtcbiAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoaGVhZGVycywgXCJwcm9wZXJ0eVwiKSkge1xuICAgICAgICBzb3J0ZWRLZXlzLnB1c2gocHJvcGVydHkpO1xuICAgICAgfVxuICAgIH1cbiAgICBzb3J0ZWRLZXlzLnNvcnQoKTtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc29ydGVkS2V5cy5sZW5ndGg7IGkrKykge1xuICAgICAgY2Fub25pY2FsSGVhZGVycyArPSBzb3J0ZWRLZXlzW2ldLnRvTG93ZXJDYXNlKCkgKyAnOicgKyBoZWFkZXJzW3NvcnRlZEtleXNbaV1dICsgJ1xcbic7XG4gICAgfVxuICAgIHJldHVybiBjYW5vbmljYWxIZWFkZXJzO1xuICB9XG5cbiAgZnVuY3Rpb24gYnVpbGRDYW5vbmljYWxTaWduZWRIZWFkZXJzKGhlYWRlcnMpIHtcbiAgICBsZXQgc29ydGVkS2V5cyA9IFtdO1xuICAgIGZvciAobGV0IHByb3BlcnR5IGluIGhlYWRlcnMpIHtcbiAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoaGVhZGVycywgXCJwcm9wZXJ0eVwiKSkge1xuICAgICAgICBzb3J0ZWRLZXlzLnB1c2gocHJvcGVydHkudG9Mb3dlckNhc2UoKSk7XG4gICAgICB9XG4gICAgfVxuICAgIHNvcnRlZEtleXMuc29ydCgpO1xuXG4gICAgcmV0dXJuIHNvcnRlZEtleXMuam9pbignOycpO1xuICB9XG5cbiAgZnVuY3Rpb24gYnVpbGRTdHJpbmdUb1NpZ24oZGF0ZXRpbWUsIGNyZWRlbnRpYWxTY29wZSwgaGFzaGVkQ2Fub25pY2FsUmVxdWVzdCkge1xuICAgIHJldHVybiBBV1NfU0hBXzI1NiArICdcXG4nICtcbiAgICAgIGRhdGV0aW1lICsgJ1xcbicgK1xuICAgICAgY3JlZGVudGlhbFNjb3BlICsgJ1xcbicgK1xuICAgICAgaGFzaGVkQ2Fub25pY2FsUmVxdWVzdDtcbiAgfVxuXG4gIGZ1bmN0aW9uIGJ1aWxkQ3JlZGVudGlhbFNjb3BlKGRhdGV0aW1lLCByZWdpb24sIHNlcnZpY2UpIHtcbiAgICByZXR1cm4gZGF0ZXRpbWUuc3Vic3RyKDAsIDgpICsgJy8nICsgcmVnaW9uICsgJy8nICsgc2VydmljZSArICcvJyArIEFXUzRfUkVRVUVTVDtcbiAgfVxuXG4gIGZ1bmN0aW9uIGNhbGN1bGF0ZVNpZ25pbmdLZXkoc2VjcmV0S2V5LCBkYXRldGltZSwgcmVnaW9uLCBzZXJ2aWNlKSB7XG4gICAgcmV0dXJuIGhtYWMoaG1hYyhobWFjKFxuICAgICAgaG1hYyhBV1M0ICsgc2VjcmV0S2V5LCBkYXRldGltZS5zdWJzdHIoMCwgOCkpLFxuICAgICAgcmVnaW9uXG4gICAgKSwgc2VydmljZSksIEFXUzRfUkVRVUVTVCk7XG4gIH1cblxuICBmdW5jdGlvbiBjYWxjdWxhdGVTaWduYXR1cmUoa2V5LCBzdHJpbmdUb1NpZ24pIHtcbiAgICByZXR1cm4gaGV4RW5jb2RlKGhtYWMoa2V5LCBzdHJpbmdUb1NpZ24pKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGJ1aWxkQXV0aG9yaXphdGlvbkhlYWRlcihhY2Nlc3NLZXksIGNyZWRlbnRpYWxTY29wZSwgaGVhZGVycywgc2lnbmF0dXJlKSB7XG4gICAgcmV0dXJuIEFXU19TSEFfMjU2ICsgJyBDcmVkZW50aWFsPScgKyBhY2Nlc3NLZXkgKyAnLycgKyBjcmVkZW50aWFsU2NvcGVcbiAgICAgICsgJywgU2lnbmVkSGVhZGVycz0nICsgYnVpbGRDYW5vbmljYWxTaWduZWRIZWFkZXJzKGhlYWRlcnMpICsgJywgU2lnbmF0dXJlPScgKyBzaWduYXR1cmU7XG4gIH1cblxuICBsZXQgYXdzU2lnVjRDbGllbnQgPSB7IH07XG4gIGlmIChjb25maWcuYWNjZXNzS2V5ID09PSB1bmRlZmluZWQgfHwgY29uZmlnLnNlY3JldEtleSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgcmV0dXJuIGF3c1NpZ1Y0Q2xpZW50O1xuICB9XG4gIGF3c1NpZ1Y0Q2xpZW50LmFjY2Vzc0tleSA9IHV0aWxzLmFzc2VydERlZmluZWQoY29uZmlnLmFjY2Vzc0tleSwgJ2FjY2Vzc0tleScpO1xuICBhd3NTaWdWNENsaWVudC5zZWNyZXRLZXkgPSB1dGlscy5hc3NlcnREZWZpbmVkKGNvbmZpZy5zZWNyZXRLZXksICdzZWNyZXRLZXknKTtcbiAgYXdzU2lnVjRDbGllbnQuc2Vzc2lvblRva2VuID0gY29uZmlnLnNlc3Npb25Ub2tlbjtcbiAgYXdzU2lnVjRDbGllbnQuc2VydmljZU5hbWUgPSB1dGlscy5hc3NlcnREZWZpbmVkKGNvbmZpZy5zZXJ2aWNlTmFtZSwgJ3NlcnZpY2VOYW1lJyk7XG4gIGF3c1NpZ1Y0Q2xpZW50LnJlZ2lvbiA9IHV0aWxzLmFzc2VydERlZmluZWQoY29uZmlnLnJlZ2lvbiwgJ3JlZ2lvbicpO1xuICBhd3NTaWdWNENsaWVudC5lbmRwb2ludCA9IHV0aWxzLmFzc2VydERlZmluZWQoY29uZmlnLmVuZHBvaW50LCAnZW5kcG9pbnQnKTtcbiAgYXdzU2lnVjRDbGllbnQucmV0cmllcyA9IGNvbmZpZy5yZXRyaWVzO1xuICBhd3NTaWdWNENsaWVudC5yZXRyeUNvbmRpdGlvbiA9IGNvbmZpZy5yZXRyeUNvbmRpdGlvbjtcbiAgYXdzU2lnVjRDbGllbnQucmV0cnlEZWxheSA9IGNvbmZpZy5yZXRyeURlbGF5O1xuICBhd3NTaWdWNENsaWVudC5ob3N0ID0gY29uZmlnLmhvc3Q7XG5cbiAgYXdzU2lnVjRDbGllbnQubWFrZVJlcXVlc3QgPSBmdW5jdGlvbihyZXF1ZXN0KSB7XG4gICAgbGV0IHZlcmIgPSB1dGlscy5hc3NlcnREZWZpbmVkKHJlcXVlc3QudmVyYiwgJ3ZlcmInKTtcbiAgICBsZXQgcGF0aCA9IHV0aWxzLmFzc2VydERlZmluZWQocmVxdWVzdC5wYXRoLCAncGF0aCcpO1xuICAgIGxldCBxdWVyeVBhcmFtcyA9IHV0aWxzLmNvcHkocmVxdWVzdC5xdWVyeVBhcmFtcyk7XG4gICAgbGV0IHRpbWVvdXQgPSB1dGlscy5jb3B5KHJlcXVlc3QudGltZW91dCk7XG5cbiAgICBpZiAocXVlcnlQYXJhbXMgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcXVlcnlQYXJhbXMgPSB7fTtcbiAgICB9XG5cbiAgICBpZiAodGltZW91dCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aW1lb3V0ID0gMDtcbiAgICB9XG4gICAgbGV0IGhlYWRlcnMgPSB1dGlscy5jb3B5KHJlcXVlc3QuaGVhZGVycyk7XG4gICAgaWYgKGhlYWRlcnMgPT09IHVuZGVmaW5lZCkge1xuICAgICAgaGVhZGVycyA9IHt9O1xuICAgIH1cblxuICAgIC8vIElmIHRoZSB1c2VyIGhhcyBub3Qgc3BlY2lmaWVkIGFuIG92ZXJyaWRlIGZvciBDb250ZW50IHR5cGUgdGhlIHVzZSBkZWZhdWx0XG4gICAgaWYgKGhlYWRlcnNbJ0NvbnRlbnQtVHlwZSddID09PSB1bmRlZmluZWQpIHtcbiAgICAgIGhlYWRlcnNbJ0NvbnRlbnQtVHlwZSddID0gY29uZmlnLmRlZmF1bHRDb250ZW50VHlwZTtcbiAgICB9XG5cbiAgICAvLyBJZiB0aGUgdXNlciBoYXMgbm90IHNwZWNpZmllZCBhbiBvdmVycmlkZSBmb3IgQWNjZXB0IHR5cGUgdGhlIHVzZSBkZWZhdWx0XG4gICAgaWYgKGhlYWRlcnNbJ0FjY2VwdCddID09PSB1bmRlZmluZWQpIHtcbiAgICAgIGhlYWRlcnNbJ0FjY2VwdCddID0gY29uZmlnLmRlZmF1bHRBY2NlcHRUeXBlO1xuICAgIH1cblxuICAgIGxldCBib2R5ID0gdXRpbHMuY29weShyZXF1ZXN0LmJvZHkpO1xuXG4gICAgLy8gc3RyaW5naWZ5IHJlcXVlc3QgYm9keSBpZiBjb250ZW50IHR5cGUgaXMgSlNPTlxuICAgIGlmIChib2R5ICYmIGhlYWRlcnNbJ0NvbnRlbnQtVHlwZSddICYmIGhlYWRlcnNbJ0NvbnRlbnQtVHlwZSddID09PSAnYXBwbGljYXRpb24vanNvbicpIHtcbiAgICAgIGJvZHkgPSBKU09OLnN0cmluZ2lmeShib2R5KTtcbiAgICB9XG5cbiAgICAvLyBJZiB0aGVyZSBpcyBubyBib2R5IHJlbW92ZSB0aGUgY29udGVudC10eXBlIGhlYWRlciBzbyBpdCBpcyBub3QgaW5jbHVkZWQgaW4gU2lnVjQgY2FsY3VsYXRpb25cbiAgICBpZiAoYm9keSA9PT0gJycgfHwgYm9keSA9PT0gdW5kZWZpbmVkIHx8IGJvZHkgPT09IG51bGwpIHtcbiAgICAgIGRlbGV0ZSBoZWFkZXJzWydDb250ZW50LVR5cGUnXTtcbiAgICB9XG5cbiAgICBsZXQgZGF0ZXRpbWUgPSBuZXcgRGF0ZShuZXcgRGF0ZSgpLmdldFRpbWUoKSArIGNvbmZpZy5zeXN0ZW1DbG9ja09mZnNldCkudG9JU09TdHJpbmcoKVxuICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9cXC5cXGR7M31aJC8sICdaJykucmVwbGFjZSgvWzotXXxcXC5cXGR7M30vZywgJycpO1xuICAgIGhlYWRlcnNbWF9BTVpfREFURV0gPSBkYXRldGltZTtcblxuICAgIGlmIChhd3NTaWdWNENsaWVudC5ob3N0KSB7XG4gICAgICBoZWFkZXJzW0hPU1RdID0gYXdzU2lnVjRDbGllbnQuaG9zdDtcbiAgICB9IGVsc2Uge1xuICAgICAgbGV0IHBhcnNlciA9IHVybFBhcnNlci5wYXJzZShhd3NTaWdWNENsaWVudC5lbmRwb2ludCk7XG4gICAgICBoZWFkZXJzW0hPU1RdID0gcGFyc2VyLmhvc3Q7XG4gICAgfVxuXG4gICAgbGV0IGNhbm9uaWNhbFJlcXVlc3QgPSBidWlsZENhbm9uaWNhbFJlcXVlc3QodmVyYiwgcGF0aCwgcXVlcnlQYXJhbXMsIGhlYWRlcnMsIGJvZHkpO1xuICAgIGxldCBoYXNoZWRDYW5vbmljYWxSZXF1ZXN0ID0gaGFzaENhbm9uaWNhbFJlcXVlc3QoY2Fub25pY2FsUmVxdWVzdCk7XG4gICAgbGV0IGNyZWRlbnRpYWxTY29wZSA9IGJ1aWxkQ3JlZGVudGlhbFNjb3BlKFxuICAgICAgZGF0ZXRpbWUsXG4gICAgICBhd3NTaWdWNENsaWVudC5yZWdpb24sXG4gICAgICBhd3NTaWdWNENsaWVudC5zZXJ2aWNlTmFtZVxuICAgICk7XG4gICAgbGV0IHN0cmluZ1RvU2lnbiA9IGJ1aWxkU3RyaW5nVG9TaWduKGRhdGV0aW1lLCBjcmVkZW50aWFsU2NvcGUsIGhhc2hlZENhbm9uaWNhbFJlcXVlc3QpO1xuICAgIGxldCBzaWduaW5nS2V5ID0gY2FsY3VsYXRlU2lnbmluZ0tleShcbiAgICAgIGF3c1NpZ1Y0Q2xpZW50LnNlY3JldEtleSxcbiAgICAgIGRhdGV0aW1lLFxuICAgICAgYXdzU2lnVjRDbGllbnQucmVnaW9uLFxuICAgICAgYXdzU2lnVjRDbGllbnQuc2VydmljZU5hbWVcbiAgICApO1xuICAgIGxldCBzaWduYXR1cmUgPSBjYWxjdWxhdGVTaWduYXR1cmUoc2lnbmluZ0tleSwgc3RyaW5nVG9TaWduKTtcbiAgICBoZWFkZXJzW0FVVEhPUklaQVRJT05dID0gYnVpbGRBdXRob3JpemF0aW9uSGVhZGVyKFxuICAgICAgYXdzU2lnVjRDbGllbnQuYWNjZXNzS2V5LFxuICAgICAgY3JlZGVudGlhbFNjb3BlLFxuICAgICAgaGVhZGVycyxcbiAgICAgIHNpZ25hdHVyZVxuICAgICk7XG4gICAgaWYgKGF3c1NpZ1Y0Q2xpZW50LnNlc3Npb25Ub2tlbiAhPT0gdW5kZWZpbmVkICYmIGF3c1NpZ1Y0Q2xpZW50LnNlc3Npb25Ub2tlbiAhPT0gJycpIHtcbiAgICAgIGhlYWRlcnNbWF9BTVpfU0VDVVJJVFlfVE9LRU5dID0gYXdzU2lnVjRDbGllbnQuc2Vzc2lvblRva2VuO1xuICAgIH1cbiAgICBkZWxldGUgaGVhZGVyc1tIT1NUXTtcblxuICAgIGxldCB1cmwgPSBjb25maWcuZW5kcG9pbnQgKyBwYXRoO1xuICAgIGxldCBxdWVyeVN0cmluZyA9IGJ1aWxkQ2Fub25pY2FsUXVlcnlTdHJpbmcocXVlcnlQYXJhbXMpO1xuICAgIGlmIChxdWVyeVN0cmluZyAhPT0gJycpIHtcbiAgICAgIHVybCArPSAnPycgKyBxdWVyeVN0cmluZztcbiAgICB9XG5cbiAgICAvLyBOZWVkIHRvIHJlLWF0dGFjaCBDb250ZW50LVR5cGUgaWYgaXQgaXMgbm90IHNwZWNpZmllZCBhdCB0aGlzIHBvaW50XG4gICAgaWYgKGhlYWRlcnNbJ0NvbnRlbnQtVHlwZSddID09PSB1bmRlZmluZWQpIHtcbiAgICAgIGhlYWRlcnNbJ0NvbnRlbnQtVHlwZSddID0gY29uZmlnLmRlZmF1bHRDb250ZW50VHlwZTtcbiAgICB9XG5cbiAgICBsZXQgc2lnbmVkUmVxdWVzdCA9IHtcbiAgICAgIGhlYWRlcnM6IGhlYWRlcnMsXG4gICAgICB0aW1lb3V0OiB0aW1lb3V0LFxuICAgICAgZGF0YTogYm9keVxuICAgIH07XG4gICAgaWYgKGNvbmZpZy5yZXRyaWVzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHNpZ25lZFJlcXVlc3QuYmFzZVVSTCA9IHVybDtcbiAgICAgIGxldCBjbGllbnQgPSBheGlvcy5jcmVhdGUoc2lnbmVkUmVxdWVzdCk7XG5cbiAgICAgIC8vIEFsbG93IHVzZXIgY29uZmlndXJhYmxlIGRlbGF5LCBvciBidWlsdC1pbiBleHBvbmVudGlhbCBkZWxheVxuICAgICAgbGV0IHJldHJ5RGVsYXkgPSBmdW5jdGlvbigpIHtcbiByZXR1cm4gMDtcbn07XG4gICAgICBpZiAoY29uZmlnLnJldHJ5RGVsYXkgPT09ICdleHBvbmVudGlhbCcpIHtcbiAgICAgICAgcmV0cnlEZWxheSA9IGF4aW9zUmV0cnkuZXhwb25lbnRpYWxEZWxheTtcbiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGNvbmZpZy5yZXRyeURlbGF5ID09PSAnbnVtYmVyJykge1xuICAgICAgICByZXRyeURlbGF5ID0gKCkgPT4gcGFyc2VJbnQoY29uZmlnLnJldHJ5RGVsYXkpO1xuICAgICAgfSBlbHNlIGlmICh0eXBlb2YgY29uZmlnLnJldHJ5RGVsYXkgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgcmV0cnlEZWxheSA9IGNvbmZpZy5yZXRyeURlbGF5O1xuICAgICAgfVxuXG4gICAgICBheGlvc1JldHJ5KGNsaWVudCwge1xuICAgICAgICByZXRyaWVzOiBjb25maWcucmV0cmllcyxcbiAgICAgICAgcmV0cnlDb25kaXRpb246IGNvbmZpZy5yZXRyeUNvbmRpdGlvbixcbiAgICAgICAgcmV0cnlEZWxheSxcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIGNsaWVudC5yZXF1ZXN0KHttZXRob2Q6IHZlcmJ9KTtcbiAgICB9XG4gICAgc2lnbmVkUmVxdWVzdC5tZXRob2QgPSB2ZXJiO1xuICAgIHNpZ25lZFJlcXVlc3QudXJsID0gdXJsO1xuICAgIHJldHVybiBheGlvcyhzaWduZWRSZXF1ZXN0KTtcbiAgfTtcblxuICByZXR1cm4gYXdzU2lnVjRDbGllbnQ7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBzaWdWNENsaWVudEZhY3Rvcnk7XG4iXX0=